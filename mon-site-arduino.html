<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Deux Ohms - Deck Master</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0f0f12;
            --bg-panel: #1e1e24;
            --accent: #339af0;
            --accent-hover: #228be6;
            --yt-red: #ff0000;
            --text-main: #e9ecef;
            --text-muted: #909296;
            --code-bg: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            padding-bottom: 50px;
        }

        /* --- HEADER & TOOLBAR --- */
        .header-area { width: 100%; max-width: 1000px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        h1 { font-weight: 300; letter-spacing: 1px; margin: 0; font-size: 1.8em; display: flex; align-items: center; gap: 10px; }
        
        .toolbar-top { display: flex; gap: 10px; background: var(--bg-panel); padding: 10px; border-radius: 10px; border: 1px solid #333; flex-wrap: wrap; }
        .btn-tool { background: #2c2e33; color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-tool:hover { background: #3c3e44; border-color: #666; }
        .btn-preset { border-color: var(--accent); color: var(--accent); }
        .btn-preset:hover { background: var(--accent); color: white; }

        /* --- VISUEL BOITIER --- */
        .deck-container {
            background: #18181b; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); display: flex; gap: 40px;
            margin-bottom: 30px; border: 1px solid #333; flex-wrap: wrap; justify-content: center;
        }

        .knob-column { display: flex; flex-direction: column; align-items: center; width: 220px; }
        .knob-visual { width: 80px; height: 80px; background: radial-gradient(circle at 30% 30%, #444, #111); border-radius: 50%; border: 4px solid #000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; margin-bottom: 25px; }
        .knob-visual::after { content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 4px; height: 20px; background: var(--accent); border-radius: 2px; box-shadow: 0 0 10px var(--accent); }
        .knob-title { font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 15px; }

        .config-card { background: var(--bg-panel); width: 100%; border-radius: 12px; padding: 15px; box-sizing: border-box; border: 1px solid #373a40; }
        .action-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #373a40; }
        .action-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .icon-box { width: 30px; text-align: center; color: var(--accent); }

        .key-display { background: #101113; border: 1px solid #5c5f66; padding: 5px 10px; border-radius: 6px; font-family: monospace; font-size: 0.85em; color: #fff; cursor: pointer; min-width: 80px; text-align: center; transition: 0.2s; }
        .key-display:hover { border-color: var(--accent); color: var(--accent); }
        .key-display.recording { background: var(--accent); color: #000; animation: pulse 1s infinite; }

        /* --- BARRE GENERATION --- */
        .action-bar { display: flex; gap: 15px; margin-bottom: 30px; justify-content: center; width: 100%; flex-wrap: wrap; }
        .btn-main { border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; color: white; }
        .btn-view { background: #343a40; } .btn-view:hover { background: #495057; }
        .btn-copy { background: linear-gradient(135deg, var(--accent), var(--accent-hover)); box-shadow: 0 4px 15px rgba(51, 154, 240, 0.3); }
        .btn-copy:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(51, 154, 240, 0.4); }

        /* --- EDITEUR --- */
        #editor-container { width: 100%; max-width: 800px; display: none; margin-bottom: 50px; }
        .editor-header { background: #2d2d2d; padding: 10px 20px; border-radius: 8px 8px 0 0; font-size: 0.9em; color: #aaa; border: 1px solid #444; border-bottom: none; }
        textarea.code-area { width: 100%; height: 300px; background: var(--code-bg); color: #d4d4d4; border: 1px solid #444; border-radius: 0 0 8px 8px; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; resize: vertical; outline: none; box-sizing: border-box; }

        /* --- SCHEMA DE CABLAGE --- */
        .wiring-section {
            width: 100%; max-width: 1000px; background: #161618; 
            border: 1px solid #333; border-radius: 20px; padding: 30px;
            display: flex; gap: 40px; align-items: center; flex-wrap: wrap; justify-content: center;
            margin-bottom: 50px;
        }
        .wiring-image img { max-width: 100%; width: 300px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); filter: brightness(1.1); transition: 0.3s; }
        .wiring-image img:hover { transform: scale(1.05); }
        
        .wiring-info { flex: 1; min-width: 300px; }
        .wiring-info h3 { margin-top: 0; color: var(--accent); font-weight: 300; letter-spacing: 1px; }
        .wiring-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .wiring-table th { text-align: left; color: var(--text-muted); border-bottom: 1px solid #444; padding: 10px 5px; }
        .wiring-table td { padding: 10px 5px; border-bottom: 1px solid #2a2a2a; }
        .pin-tag { background: #2c2e33; padding: 2px 8px; border-radius: 4px; font-family: monospace; color: #a5d8ff; border: 1px solid #444; }

        /* --- FOOTER --- */
        .yt-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #333; width: 100%; text-align: center; }
        .yt-link { display: inline-flex; align-items: center; gap: 10px; text-decoration: none; color: white; font-size: 1.2em; background: #202020; padding: 10px 25px; border-radius: 50px; transition: 0.3s; border: 1px solid #333; }
        .yt-link:hover { background: #2a2a2a; border-color: var(--yt-red); box-shadow: 0 0 20px rgba(255, 0, 0, 0.2); }
        .yt-icon { color: var(--yt-red); font-size: 1.5em; }
        .creator-text { color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px; display: block; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="header-area">
        <h1><i class="fas fa-gamepad"></i> DECK MASTER</h1>
        
        <div class="toolbar-top">
            <button class="btn-tool" onclick="saveProfile()" title="Sauvegarder en JSON"><i class="fas fa-save"></i> Sauvegarder</button>
            <button class="btn-tool" onclick="document.getElementById('fileInput').click()" title="Charger JSON"><i class="fas fa-folder-open"></i> Charger</button>
            <input type="file" id="fileInput" accept=".json" onchange="loadProfile(this)">
            <div style="width: 1px; background: #444; margin: 0 10px;"></div>
            <button class="btn-tool btn-preset" onclick="loadPreset('photoshop')"><i class="fas fa-paint-brush"></i> Ps</button>
            <button class="btn-tool btn-preset" onclick="loadPreset('premiere')"><i class="fas fa-video"></i> Pr</button>
            <button class="btn-tool btn-preset" onclick="loadPreset('obs')"><i class="fas fa-broadcast-tower"></i> OBS</button>
        </div>
    </div>

    <div class="deck-container">
        <div id="deck-grid" style="display:contents"></div>
    </div>

    <div class="action-bar">
        <button class="btn-main btn-view" onclick="toggleCode(true)"><i class="fas fa-eye"></i> Voir le Code</button>
        <button class="btn-main btn-view" onclick="toggleCode(false)"><i class="fas fa-pen"></i> Modifier</button>
        <button class="btn-main btn-copy" onclick="copyCode()"><i class="fas fa-file-export"></i> Copier pour Arduino</button>
    </div>

    <div id="editor-container">
        <div class="editor-header">arduino_sketch.ino</div>
        <textarea id="codeArea" class="code-area" spellcheck="false"></textarea>
    </div>

    <div class="wiring-section">
        <div class="wiring-image">
            <img src="https://www.xab3.ro/assets/img/products/atmega32u4-3_3v-8mhz1.png" alt="Arduino Pro Micro Pinout">
        </div>
        <div class="wiring-info">
            <h3><i class="fas fa-plug"></i> Guide de Connexion</h3>
            <p style="color:#888; font-size:0.9em; margin-bottom:20px;">Connectez tous les <strong>GND</strong> et <strong>VCC</strong> (5V) des encodeurs ensemble.</p>
            
            <table class="wiring-table">
                <thead>
                    <tr>
                        <th>Encodeur (Gauche à Droite)</th>
                        <th>DT (Pin)</th>
                        <th>CLK (Pin)</th>
                        <th>SW (Bouton)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Encodeur 1</strong></td>
                        <td><span class="pin-tag">2</span></td>
                        <td><span class="pin-tag">3</span></td>
                        <td><span class="pin-tag">8</span></td>
                    </tr>
                    <tr>
                        <td><strong>Encodeur 2</strong></td>
                        <td><span class="pin-tag">4</span></td>
                        <td><span class="pin-tag">5</span></td>
                        <td><span class="pin-tag">9</span></td>
                    </tr>
                    <tr>
                        <td><strong>Encodeur 3</strong></td>
                        <td><span class="pin-tag">6</span></td>
                        <td><span class="pin-tag">7</span></td>
                        <td><span class="pin-tag">10</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="yt-footer">
        <span class="creator-text">Outil offert par</span>
        <a href="https://www.youtube.com/@DeuxOhms" target="_blank" class="yt-link">
            <i class="fab fa-youtube yt-icon"></i> Deux Ohms
        </a>
    </footer>

    <script>
        // --- CONFIG & DOM ---
        const actions = [ { id: 'ccw', icon: 'fa-undo' }, { id: 'sw', icon: 'fa-fingerprint' }, { id: 'cw', icon: 'fa-redo' } ];
        const grid = document.getElementById('deck-grid');
        let config = {};

        // Génération HTML
        for (let i = 1; i <= 3; i++) {
            let html = `<div class="knob-column"><div class="knob-visual"></div><div class="knob-title">Encodeur ${i}</div><div class="config-card">`;
            actions.forEach(act => {
                html += `<div class="action-row"><div class="icon-box"><i class="fas ${act.icon}"></i></div><div class="key-display" id="disp_${i}_${act.id}" onclick="record(${i}, '${act.id}')">...</div></div>`;
            });
            html += `</div></div>`;
            grid.innerHTML += html;
        }

        // --- PRESETS ---
        const presets = {
            photoshop: {
                1: { cw: {key:']',mods:[],arduinoKey:"']'"}, ccw: {key:'[',mods:[],arduinoKey:"'['"}, sw: {key:'SPACE',mods:[],arduinoKey:"' '"} },
                2: { cw: {key:'+',mods:['CTRL'],arduinoKey:"KEY_KP_PLUS"}, ccw: {key:'-',mods:['CTRL'],arduinoKey:"KEY_KP_MINUS"}, sw: {key:'0',mods:['CTRL'],arduinoKey:"'0'"} },
                3: { cw: {key:'Z',mods:['CTRL','SHIFT'],arduinoKey:"'z'"}, ccw: {key:'Z',mods:['CTRL'],arduinoKey:"'z'"}, sw: {key:'S',mods:['CTRL'],arduinoKey:"'s'"} }
            },
            premiere: {
                1: { cw: {key:'RIGHT',mods:[],arduinoKey:"KEY_RIGHT_ARROW"}, ccw: {key:'LEFT',mods:[],arduinoKey:"KEY_LEFT_ARROW"}, sw: {key:'SPACE',mods:[],arduinoKey:"' '"} },
                2: { cw: {key:'=',mods:[],arduinoKey:"'='"}, ccw: {key:'-',mods:[],arduinoKey:"'-'"}, sw: {key:'M',mods:[],arduinoKey:"'m'"} },
                3: { cw: {key:'K',mods:['CTRL'],arduinoKey:"'k'"}, ccw: {key:'Z',mods:['CTRL'],arduinoKey:"'z'"}, sw: {key:'S',mods:['CTRL'],arduinoKey:"'s'"} }
            },
            obs: {
                1: { cw: {key:'F2',mods:[],arduinoKey:"KEY_F2"}, ccw: {key:'F1',mods:[],arduinoKey:"KEY_F1"}, sw: {key:'F12',mods:[],arduinoKey:"KEY_F12"} },
                2: { cw: {key:'UP',mods:['ALT'],arduinoKey:"KEY_UP_ARROW"}, ccw: {key:'DOWN',mods:['ALT'],arduinoKey:"KEY_DOWN_ARROW"}, sw: {key:'M',mods:['ALT'],arduinoKey:"'m'"} }
            }
        };

        function loadPreset(name) {
            if(confirm(`Charger le preset ${name} ?`)) { config = JSON.parse(JSON.stringify(presets[name])); updateUI(); }
        }

        function saveProfile() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
            const a = document.createElement('a'); a.href = dataStr; a.download = "deck_profile.json";
            document.body.appendChild(a); a.click(); a.remove();
        }

        function loadProfile(input) {
            const file = input.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = e => { try { config = JSON.parse(e.target.result); updateUI(); alert("✅ Chargé !"); } catch(err) { alert("Erreur fichier"); } };
            r.readAsText(file); input.value = '';
        }

        function updateUI() {
            document.querySelectorAll('.key-display').forEach(el => el.innerText = "...");
            for (const [ei, ed] of Object.entries(config)) {
                for (const [ai, ad] of Object.entries(ed)) {
                    const el = document.getElementById(`disp_${ei}_${ai}`);
                    if(el && ad.key) el.innerText = (ad.mods.length ? ad.mods.join('+')+"+" : "") + ad.key;
                }
            }
        }

        // --- ENREGISTREMENT ---
        let recordingState = null;
        function record(enc, type) {
            if(recordingState) return;
            const el = document.getElementById(`disp_${enc}_${type}`);
            const originalText = el.innerText;
            el.innerText = "?"; el.classList.add('recording');
            recordingState = { enc, type, el, originalText };
            document.addEventListener('keydown', handleKey); document.addEventListener('mousedown', cancelOutside);
        }

        function cancelOutside(e) {
            if(recordingState && e.target !== recordingState.el && !recordingState.el.contains(e.target)) {
                recordingState.el.innerText = recordingState.originalText; recordingState.el.classList.remove('recording'); cleanupRecord();
            }
        }
        function cleanupRecord() { document.removeEventListener('keydown', handleKey); document.removeEventListener('mousedown', cancelOutside); recordingState = null; }

        function handleKey(e) {
            e.preventDefault(); if(!recordingState) return;
            if(['Control','Shift','Alt','Meta'].includes(e.key)) return;
            let mods = []; if(e.ctrlKey) mods.push("CTRL"); if(e.shiftKey) mods.push("SHIFT"); if(e.altKey) mods.push("ALT"); if(e.metaKey) mods.push("GUI");
            let key = e.key.toUpperCase();
            const nice = { ' ': 'SPACE', 'ENTER': 'ENTER', 'ESCAPE': 'ESC', 'ARROWUP': 'UP', 'ARROWDOWN': 'DOWN', 'ARROWLEFT': 'LEFT', 'ARROWRIGHT': 'RIGHT' };
            if(nice[key]) key = nice[key];
            if(!config[recordingState.enc]) config[recordingState.enc] = {};
            config[recordingState.enc][recordingState.type] = { key, mods, arduinoKey: mapToArduino(key) };
            updateUI(); recordingState.el.classList.remove('recording'); cleanupRecord();
        }

        function mapToArduino(key) {
            if(key.length === 1) return `'${key.toLowerCase()}'`;
            const m = { 'SPACE': "' '", 'ENTER': 'KEY_RETURN', 'ESC': 'KEY_ESC', 'UP': 'KEY_UP_ARROW', 'DOWN': 'KEY_DOWN_ARROW', 'LEFT': 'KEY_LEFT_ARROW', 'RIGHT': 'KEY_RIGHT_ARROW', 'F1':'KEY_F1', 'F2':'KEY_F2', 'F12':'KEY_F12' };
            return m[key] || '0';
        }

        // --- CODE GEN ---
        function generateSource() {
            let c = `/* Généré par Deux Ohms Configurator - https://www.youtube.com/@DeuxOhms */
#include <Encoder.h>
#include <HID-Project.h>

Encoder enc1(2, 3); const int sw1 = 8;
Encoder enc2(4, 5); const int sw2 = 9;
Encoder enc3(6, 7); const int sw3 = 10;
long old1=0, old2=0, old3=0;

void setup() {
  pinMode(sw1, INPUT_PULLUP); pinMode(sw2, INPUT_PULLUP); pinMode(sw3, INPUT_PULLUP);
  Consumer.begin(); Keyboard.begin();
}

void loop() {
  check(1, enc1, sw1, old1); check(2, enc2, sw2, old2); check(3, enc3, sw3, old3); delay(5);
}

void check(int id, Encoder &e, int sw, long &old) {
  long newP = e.read() / 4;
  if(newP != old) { if(newP > old) trig(id, "cw"); else trig(id, "ccw"); old = newP; }
  if(digitalRead(sw) == LOW) { trig(id, "sw"); delay(300); }
}

void trig(int id, String t) {
`;
            for(let i=1; i<=3; i++) {
                if(config[i]) {
                    ['cw','ccw','sw'].forEach(type => {
                        if(config[i][type]) {
                            c += `  if(id==${i} && t=="${type}") { `;
                            config[i][type].mods.forEach(m => c += `Keyboard.press(KEY_LEFT_${m}); `);
                            c += `Keyboard.press(${config[i][type].arduinoKey}); Keyboard.releaseAll(); }\n`;
                        }
                    });
                }
            }
            c += `}`; return c;
        }

        function toggleCode(readonly) {
            const area = document.getElementById('codeArea'); const container = document.getElementById('editor-container');
            if(readonly || area.value.trim() === "") area.value = generateSource();
            area.readOnly = readonly; area.style.color = readonly ? '#aaa' : '#d4d4d4';
            container.style.display = 'block'; container.scrollIntoView({behavior: "smooth"});
        }

        function copyCode() {
            const area = document.getElementById('codeArea'); let text = area.value || generateSource();
            navigator.clipboard.writeText(text).then(() => alert("✅ Code copié !"));
        }
    </script>
</body>
</html>